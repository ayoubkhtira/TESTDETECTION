import streamlit as st
import cv2
import requests
import time
import os
import pandas as pd
import numpy as np
from datetime import datetime
from ultralytics import YOLO
from PIL import Image
import plotly.express as px
import plotly.graph_objects as go
from collections import Counter
import warnings
warnings.filterwarnings('ignore')

# --- CONFIGURATION ---
st.set_page_config(
    page_title="VisionGuard AI Pro",
    layout="wide",
    page_icon="ğŸ”",
    initial_sidebar_state="expanded"
)

# --- CSS POUR THÃˆME MODERNE ---
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
        font-family: 'Inter', sans-serif;
    }
    
    .main {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stApp {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 4px solid #667eea;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .stButton>button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .stButton>button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .alert-badge {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
        margin: 0.25rem;
    }
    
    .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        margin: 0.5rem 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .sidebar .sidebar-content {
        background: linear-gradient(180deg, #2c3e50 0%, #1a1a2e 100%);
        color: white;
    }
    </style>
""", unsafe_allow_html=True)

# --- INITIALISATION ---
if 'history' not in st.session_state:
    st.session_state.history = []
if 'detection_stats' not in st.session_state:
    st.session_state.detection_stats = Counter()
if 'last_analysis_time' not in st.session_state:
    st.session_state.last_analysis_time = 0

@st.cache_resource
def load_models():
    """Charge les modÃ¨les YOLO et DeepFace"""
    yolo_model = YOLO("yolov8n.pt")
    return yolo_model

def analyze_demographics(image):
    """Analyse le genre et l'Ã¢ge d'un visage"""
    try:
        analysis = DeepFace.analyze(
            img_path=image,
            actions=['gender', 'age'],
            enforce_detection=False,
            detector_backend='opencv',
            silent=True
        )
        if analysis and len(analysis) > 0:
            gender = "Homme" if analysis[0]['gender']['Man'] > analysis[0]['gender']['Woman'] else "Femme"
            age = int(analysis[0]['age'])
            confidence = max(analysis[0]['gender']['Man'], analysis[0]['gender']['Woman'])
            return gender, age, confidence
    except:
        pass
    return None, None, None

@st.cache_resource
def load_model():
    return YOLO("yolov8n.pt")

model = load_model()

# --- FONCTION D'ENVOI ---
def send_telegram(image_np, caption, token, chat_id):
    try:
        temp_path = "last_alert.jpg"
        cv2.imwrite(temp_path, cv2.cvtColor(image_np, cv2.COLOR_RGB2BGR))
        url = f"https://api.telegram.org/bot{token}/sendPhoto"
        with open(temp_path, 'rb') as photo:
            res = requests.post(url, data={'chat_id': chat_id, 'caption': caption}, 
                              files={'photo': photo}, timeout=5)
        return res.status_code == 200
    except:
        return False

# --- UI : BARRE LATERALE ---
with st.sidebar:
    st.markdown("""
        <div style="text-align: center; padding: 1rem 0;">
            <h2 style="color: white; margin-bottom: 0.5rem;">ğŸ” VisionGuard AI</h2>
            <p style="color: #b3b3b3; font-size: 0.9rem;">SystÃ¨me de surveillance intelligent</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.divider()
    
    with st.expander("ğŸ” Configuration Telegram", expanded=True):
        token = st.text_input("Bot Token", type="password", value="", placeholder="Entrez votre token Telegram")
        chat_id = st.text_input("Chat ID", value="", placeholder="Entrez votre Chat ID")
    
    st.divider()
    
    with st.expander("âš™ï¸ ParamÃ¨tres de dÃ©tection", expanded=True):
        conf_level = st.slider("Seuil de confiance", 0.1, 0.9, 0.6)
        cooldown = st.slider("DÃ©lai entre alertes (s)", 5, 300, 30)
        require_person = st.toggle("Alerte uniquement avec personne", value=True)
        enable_demographics = st.toggle("Analyse dÃ©mographique", value=True)
    
    st.divider()
    
    col1, col2 = st.columns(2)
    with col1:
        run_app = st.button("â–¶ï¸ DÃ©marrer", use_container_width=True, type="primary")
    with col2:
        stop_app = st.button("â¹ï¸ ArrÃªter", use_container_width=True)
    
    st.divider()
    
    # Statistiques en temps rÃ©el
    if st.session_state.detection_stats:
        st.markdown("### ğŸ“Š Statistiques actuelles")
        for obj, count in st.session_state.detection_stats.most_common(5):
            st.progress(min(count/10, 1.0), f"{obj}: {count}")

# --- UI : EN-TÃŠTE PRINCIPALE ---
st.markdown("""
    <div class="main-header">
        <h1 style="margin: 0; font-size: 2.5rem;">ğŸ” VisionGuard AI Pro</h1>
        <p style="margin: 0.5rem 0 0 0; font-size: 1.1rem; opacity: 0.9;">
            SystÃ¨me avancÃ© de surveillance et d'analyse en temps rÃ©el
        </p>
    </div>
""", unsafe_allow_html=True)

# --- UI : MÃ‰TRIQUES EN TEMPS RÃ‰EL ---
col1, col2, col3, col4 = st.columns(4)

with col1:
    st.markdown('<div class="metric-card">', unsafe_allow_html=True)
    st.metric("ğŸ‘¥ Personnes dÃ©tectÃ©es", "0", delta=None)
    st.markdown('</div>', unsafe_allow_html=True)

with col2:
    st.markdown('<div class="metric-card">', unsafe_allow_html=True)
    st.metric("ğŸ“± TÃ©lÃ©phones dÃ©tectÃ©s", "0", delta=None)
    st.markdown('</div>', unsafe_allow_html=True)

with col3:
    st.markdown('<div class="metric-card">', unsafe_allow_html=True)
    st.metric("ğŸ­ Analyse dÃ©mographique", "Active", delta=None)
    st.markdown('</div>', unsafe_allow_html=True)

with col4:
    st.markdown('<div class="metric-card">', unsafe_allow_html=True)
    st.metric("âš¡ FPS", "0", delta=None)
    st.markdown('</div>', unsafe_allow_html=True)

# --- UI : PRINCIPAL ---
tab1, tab2, tab3 = st.tabs(["ğŸ¥ Surveillance", "ğŸ“Š Analytics", "ğŸ“‹ Historique"])

with tab1:
    col_video, col_stats = st.columns([2, 1])
    
    with col_video:
        st.markdown("### ğŸ”´ Flux vidÃ©o en direct")
        video_feed = st.image([], use_column_width=True)
        
        # ContrÃ´les vidÃ©o
        col_controls = st.columns(3)
        with col_controls[0]:
            if st.button("ğŸ“¸ Capture", use_container_width=True):
                st.session_state.last_capture = datetime.now()
        with col_controls[1]:
            record = st.toggle("ğŸ¥ Enregistrer", value=False)
        with col_controls[2]:
            if st.button("ğŸ”„ RÃ©initialiser stats", use_container_width=True):
                st.session_state.detection_stats = Counter()
    
    with col_stats:
        st.markdown("### ğŸ“ˆ DÃ©tections en cours")
        stats_placeholder = st.empty()
        
        st.markdown("### ğŸ‘¤ DÃ©mographie")
        demo_placeholder = st.empty()
        
        st.markdown("### ğŸš¨ Alertes rÃ©centes")
        alert_placeholder = st.empty()

with tab2:
    st.markdown("### ğŸ“Š Analytics approfondis")
    
    if st.session_state.history:
        # Graphique temporel
        df_history = pd.DataFrame(st.session_state.history)
        df_history['Heure'] = pd.to_datetime(df_history['Heure'])
        
        col_chart1, col_chart2 = st.columns(2)
        
        with col_chart1:
            fig1 = px.line(df_history, x='Heure', y='Personnes', 
                          title="Ã‰volution du nombre de personnes")
            st.plotly_chart(fig1, use_container_width=True)
        
        with col_chart2:
            if 'DÃ©mographie' in df_history.columns:
                demo_data = df_history['DÃ©mographie'].explode().value_counts()
                fig2 = px.pie(values=demo_data.values, names=demo_data.index,
                             title="RÃ©partition dÃ©mographique")
                st.plotly_chart(fig2, use_container_width=True)
        
        # Heatmap des objets dÃ©tectÃ©s
        if 'Objets' in df_history.columns:
            st.markdown("### ğŸ”¥ Heatmap des objets dÃ©tectÃ©s")
            all_objects = []
            for obj_list in df_history['Objets']:
                all_objects.extend(obj_list)
            
            obj_counts = pd.Series(all_objects).value_counts()
            fig3 = px.bar(x=obj_counts.index, y=obj_counts.values,
                         title="FrÃ©quence des objets dÃ©tectÃ©s")
            st.plotly_chart(fig3, use_container_width=True)

with tab3:
    st.markdown("### ğŸ“‹ Historique complet")
    if st.session_state.history:
        df_display = pd.DataFrame(st.session_state.history)
        
        # Formater les colonnes
        if 'Objets' in df_display.columns:
            df_display['Objets'] = df_display['Objets'].apply(
                lambda x: ', '.join([f"{k}({v})" for k, v in x.items()]) if isinstance(x, dict) else str(x)
            )
        
        st.dataframe(df_display, use_container_width=True, height=400)
        
        # Boutons d'export
        col_export = st.columns(3)
        with col_export[0]:
            if st.button("ğŸ“„ Exporter CSV"):
                csv = df_display.to_csv(index=False)
                st.download_button("TÃ©lÃ©charger CSV", csv, "historique.csv")
        with col_export[1]:
            if st.button("ğŸ“Š Exporter Excel"):
                excel_buffer = df_display.to_excel(index=False)
                st.download_button("TÃ©lÃ©charger Excel", excel_buffer, "historique.xlsx")
    else:
        st.info("Aucun historique disponible")

# --- BOUCLE PRINCIPALE ---
if run_app and token and chat_id:
    cap = cv2.VideoCapture(0)
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
    
    last_alert_time = 0
    fps_counter = 0
    fps_time = time.time()
    
    while cap.isOpened() and not stop_app:
        ret, frame = cap.read()
        if not ret:
            st.error("Erreur de capture vidÃ©o")
            break
        
        # Calcul FPS
        fps_counter += 1
        if time.time() - fps_time >= 1:
            fps = fps_counter
            fps_counter = 0
            fps_time = time.time()
        
        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        results = model(frame_rgb, conf=conf_level, verbose=False)
        
        # Analyse des objets
        names = model.names
        detected_objects = Counter([names[int(c)] for c in results[0].boxes.cls])
        
        # Mettre Ã  jour les stats globales
        for obj, count in detected_objects.items():
            st.session_state.detection_stats[obj] += count
        
        person_count = detected_objects.get('person', 0)
        phone_count = detected_objects.get('cell phone', 0)
        
        # Analyse dÃ©mographique
        demographics_info = []
        if enable_demographics and person_count > 0:
            current_time = time.time()
            if current_time - st.session_state.last_analysis_time > 2:  # Toutes les 2 secondes
                try:
                    # Extraire les visages
                    for i, box in enumerate(results[0].boxes):
                        if names[int(box.cls)] == 'person':
                            x1, y1, x2, y2 = map(int, box.xyxy[0])
                            face_region = frame_rgb[y1:y2, x1:x2]
                            
                            if face_region.size > 0:
                                gender, age, conf = analyze_demographics(face_region)
                                if gender and age:
                                    demographics_info.append({
                                        'gender': gender,
                                        'age': age,
                                        'confidence': conf
                                    })
                except:
                    pass
                st.session_state.last_analysis_time = current_time
        
        # Logique d'alerte
        current_time = time.time()
        should_alert = phone_count > 0
        if require_person and person_count == 0:
            should_alert = False
        
        if should_alert and (current_time - last_alert_time > cooldown):
            annotated_img = results[0].plot()
            timestamp = datetime.now().strftime("%H:%M:%S")
            
            # Construire le message dÃ©taillÃ©
            alert_msg = f"""
ğŸš¨ **ALERTE VISIONGUARD** ğŸš¨
â° Heure: {timestamp}
ğŸ“ DÃ©tections:
â€¢ ğŸ“± TÃ©lÃ©phones: {phone_count}
â€¢ ğŸ‘¥ Personnes: {person_count}
â€¢ ğŸ“¦ Total objets: {sum(detected_objects.values())}
            """
            
            if demographics_info:
                avg_age = np.mean([d['age'] for d in demographics_info])
                gender_dist = Counter([d['gender'] for d in demographics_info])
                alert_msg += f"""
ğŸ“Š DÃ©mographie:
â€¢ ğŸ§‘ Hommes: {gender_dist.get('Homme', 0)}
â€¢ ğŸ‘© Femmes: {gender_dist.get('Femme', 0)}
â€¢ ğŸ‚ Ã‚ge moyen: {int(avg_age)} ans
                """
            
            success = send_telegram(annotated_img, alert_msg, token, chat_id)
            
            if success:
                # Sauvegarder dans l'historique
                history_entry = {
                    "Heure": timestamp,
                    "TÃ©lÃ©phones": phone_count,
                    "Personnes": person_count,
                    "Objets": dict(detected_objects),
                    "DÃ©mographie": demographics_info if demographics_info else "Non analysÃ©",
                    "Statut": "Alerte envoyÃ©e"
                }
                st.session_state.history.insert(0, history_entry)
                last_alert_time = current_time
                
                # Notification
                st.toast(f"ğŸš¨ Alerte envoyÃ©e Ã  {timestamp}", icon="ğŸ“©")
        
        # Mise Ã  jour UI - Flux vidÃ©o
        annotated_frame = results[0].plot()
        
        # Ajouter des infos sur le frame
        cv2.putText(annotated_frame, f"FPS: {fps}", (10, 30),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        cv2.putText(annotated_frame, f"Objets: {len(detected_objects)}", (10, 60),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
        
        video_feed.image(annotated_frame, use_column_width=True)
        
        # Mise Ã  jour UI - Statistiques
        with col_stats:
            stats_text = ""
            for obj, count in detected_objects.most_common(10):
                stats_text += f"**{obj}**: {count}\n"
            stats_placeholder.markdown(stats_text)
            
            # DÃ©mographie
            if demographics_info:
                demo_text = ""
                for demo in demographics_info:
                    demo_text += f"â€¢ {demo['gender']}, ~{demo['age']} ans ({(demo['confidence']*100):.0f}%)\n"
                demo_placeholder.markdown(demo_text)
            else:
                demo_placeholder.info("Analyse en attente...")
        
        # Mise Ã  jour mÃ©triques
        with col1:
            st.metric("ğŸ‘¥ Personnes dÃ©tectÃ©es", person_count)
        with col2:
            st.metric("ğŸ“± TÃ©lÃ©phones dÃ©tectÃ©s", phone_count)
        with col4:
            st.metric("âš¡ FPS", fps)
    
    cap.release()
    cv2.destroyAllWindows()
elif run_app and (not token or not chat_id):
    st.warning("Veuillez configurer les informations Telegram pour dÃ©marrer le systÃ¨me")
else:
    # Ã‰cran d'accueil
    st.markdown("""
        <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h2 style="color: #667eea; margin-bottom: 1rem;">ğŸ¯ PrÃªt Ã  dÃ©marrer</h2>
            <p style="color: #666; margin-bottom: 2rem;">
                Configurez vos paramÃ¨tres dans la barre latÃ©rale et cliquez sur "DÃ©marrer" pour lancer la surveillance
            </p>
            <div style="font-size: 4rem; color: #764ba2; margin-bottom: 2rem;">ğŸ”</div>
            <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem 2rem; border-radius: 30px; font-weight: 600;">
                SystÃ¨me en attente
            </div>
        </div>
    """, unsafe_allow_html=True)
    
    # Features showcase
    st.markdown("### ğŸš€ FonctionnalitÃ©s avancÃ©es")
    features_cols = st.columns(3)
    
    features = [
        ("ğŸ¯ DÃ©tection multi-objets", "DÃ©tecte et compte tous les objets visibles"),
        ("ğŸ‘¤ Analyse dÃ©mographique", "Estime le genre et l'Ã¢ge des personnes"),
        ("ğŸ“Š Analytics temps rÃ©el", "Graphiques et statistiques en direct"),
        ("ğŸ”” Alertes intelligentes", "Notifications Telegram configurables"),
        ("ğŸ’¾ Historique complet", "Export CSV/Excel des dÃ©tections"),
        ("âš¡ Performances optimisÃ©es", "Traitement en temps rÃ©el rapide")
    ]
    
    for i, (title, desc) in enumerate(features):
        with features_cols[i % 3]:
            st.markdown(f"""
                <div class="stat-card">
                    <h4 style="margin: 0 0 0.5rem 0; color: #667eea;">{title}</h4>
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">{desc}</p>
                </div>
            """, unsafe_allow_html=True)

# --- PIED DE PAGE ---
st.markdown("""
    <div style="text-align: center; margin-top: 3rem; padding: 1.5rem; color: #666; font-size: 0.9rem; border-top: 1px solid #eee;">
        <p>ğŸ” <strong>VisionGuard AI Pro</strong> | SystÃ¨me de surveillance intelligent v2.0</p>
        <p style="font-size: 0.8rem; opacity: 0.7;">ProtÃ©gez votre espace avec l'intelligence artificielle</p>
    </div>
""", unsafe_allow_html=True)
